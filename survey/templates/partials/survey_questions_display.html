{% load survey_extras %}
{% for section in questions|group_by_sections:survey.shuffle_questions %}
<div x-data="surveySection"
        x-show="page === {{ forloop.counter0 }}" 
        class="space-y-8" 
        x-transition:enter="transition ease-out duration-300 delay-100" 
        x-transition:enter-start="opacity-0 translate-y-4" 
        x-transition:enter-end="opacity-100 translate-y-0"
        @change="validate"
        @input.debounce.200ms="validate">
    
    <!-- Section Header Display -->
    {% if section.title != "Section 1" or not forloop.first %}
        <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden mb-6">
            <div class="h-1.5 bg-primary"></div>
            <div class="p-6">
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-extrabold text-slate-800 tracking-tight">
                            {{ section.title }}
                        </h2>
                        {% if section.description %}
                        <p class="mt-2 text-slate-500">{{ section.description }}</p>
                        {% endif %}
                    </div>
                    <div class="hidden md:flex items-center gap-2 text-slate-400">
                        <span class="badge badge-primary badge-outline badge-lg gap-2 text-xs font-bold uppercase tracking-widest pl-3">
                            SECTION {{ forloop.counter }} Of {{ questions|group_by_sections:survey.shuffle_questions|length }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Questions in this Section -->
    {% for q in section.questions %}
    <div class="card bg-white shadow-sm border border-slate-200/60 rounded-2xl transition-all duration-300 hover:shadow-md hover:border-slate-300">
        <div class="card-body p-6 md:p-8">
            <!-- Header: Question Text & Badges -->
            <div class="flex flex-col gap-3 mb-6">
                <div class="flex items-start justify-between gap-4">
                    <h3 class="text-xl md:text-2xl font-bold text-slate-800 leading-snug">
                        <span class="text-slate-300 font-normal mr-2 text-lg">Q{{ q.position }}</span> 
                        {{ q.label|default:"Question" }} 
                    </h3>
                    {% if q.required %}
                        <div class="tooltip tooltip-left" data-tip="Required">
                            <span class="w-2 h-2 rounded-full bg-red-500 block mt-2 shadow-[0_0_8px_rgba(239,68,68,0.6)]"></span>
                        </div>
                    {% endif %}
                </div>
                
                {% if q.helper_text %}
                    <p class="text-slate-500 text-sm font-medium pl-1 flex items-center gap-2">
                        <i class="fa-regular fa-circle-question text-slate-400"></i>
                        {{ q.helper_text }}
                    </p>
                {% endif %}
            </div>

            <!-- 1. MULTI-CHOICE -->
            {% if q.NAME == 'Multi-Choice Question' %}
            <div class="flex flex-col gap-3" 
                {% if q.required and q.allow_multiple %}data-required-checkbox-group{% endif %}
                {% if q.allow_multiple %}data-min-required="{{ q.the_minimum_number_of_options_to_be_selected }}"{% endif %}>
                {% for option in q.options|shuffle_if:q.randomize_options %}
                <label class="group relative flex items-center p-4 rounded-xl border border-slate-200 bg-slate-50/50 cursor-pointer transition-all duration-200 
                            hover:border-primary hover:bg-white hover:shadow-md hover:shadow-primary/5
                            has-[:checked]:border-primary has-[:checked]:bg-primary/5 has-[:checked]:shadow-md">
                    {% if q.allow_multiple %}
                        <input type="checkbox" name="question_{{ q.position }}" value="{{ option }}" class="peer toggle checkbox-primary checkbox-sm border-slate-300 rounded-md">
                    {% else %}
                        <input type="radio" name="question_{{ q.position }}" value="{{ option }}" class="peer radio radio-primary radio-sm border-slate-300" {% if q.required %}required{% endif %}>
                    {% endif %}
                    <span class="ml-4 text-base font-medium text-slate-600 transition-colors group-hover:text-slate-900 peer-checked:text-primary-focus peer-checked:font-bold">
                        {{ option }}
                    </span>
                </label>
                {% endfor %}
            </div>
            {% if q.allow_multiple and q.the_minimum_number_of_options_to_be_selected > 1 %}
                 <p class="text-xs text-info mb-2 flex items-center gap-1">
                    <i class="fa-solid fa-circle-info"></i>
                    Please select at least {{ q.the_minimum_number_of_options_to_be_selected }} options.
                 </p>
            {% endif %}
            <!-- 2. LIKERT -->
            {% elif q.NAME == 'Likert Question' %}
                <div class="mt-4">
                    <div class="flex flex-wrap sm:flex-nowrap justify-between items-center gap-4 py-4 px-2">
                        {% for option in q.options %}
                        <label class="flex flex-col items-center gap-3 w-full sm:w-auto cursor-pointer group">
                            <input type="radio" name="question_{{ q.position }}" value="{{ option }}" class="peer radio radio-primary radio-lg border-2 border-slate-300 group-hover:scale-110 group-hover:border-primary transition-all" {% if q.required %}required{% endif %}>
                            <span class="text-xs font-semibold text-slate-500 text-center uppercase tracking-wide group-hover:text-primary peer-checked:text-primary peer-checked:font-bold transition-colors">
                                {{ option }}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            
            <!-- 3. TEXT -->
            {% elif q.NAME == 'Text Question' %}
                <div class="form-control mt-2 group-focus-within:text-primary">
                    {% if q.is_long_answer %}
                        <textarea name="question_{{ q.position }}" class="textarea textarea-bordered textarea-lg w-full min-h-[120px] focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all placeholder:text-slate-300 text-slate-700 leading-relaxed bg-slate-50 focus:bg-white" 
                            placeholder="Type your detailed answer here..."
                        {% if q.min_length %}minlength="{{ q.min_length }}"{% endif %}
                        {% if q.max_length %}maxlength="{{ q.max_length }}"{% endif %}
                        {% if q.required %}required{% endif %}></textarea>
                    {% else %}
                        <input type="text" name="question_{{ q.position }}" class="input input-bordered input-lg w-full focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all placeholder:text-slate-300 bg-slate-50 focus:bg-white" 
                            placeholder="Type your short answer..."
                        {% if q.min_length %}minlength="{{ q.min_length }}"{% endif %}
                        {% if q.max_length %}maxlength="{{ q.max_length }}"{% endif %}
                        {% if q.required %}required{% endif %} />
                    {% endif %}
                </div>

            <!-- 4. MATRIX -->
            {% elif q.NAME == 'Matrix Question' %}
                <div class="overflow-x-auto -mx-4 sm:mx-0 rounded-xl border border-slate-200 bg-slate-50/30">
                    <table class="table w-full">
                        <thead class="bg-slate-50/80 border-b border-slate-200">
                            <tr>
                                <th class="min-w-[150px] bg-transparent"></th> 
                                {% for col in q.columns %}
                                    <th class="text-center min-w-[80px] text-xs font-bold text-slate-400 uppercase tracking-wide p-4">{{ col }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in q.rows %}
                            <tr class="hover:bg-white transition-colors border-b border-slate-100 last:border-0 group">
                                <td class="font-medium text-slate-600 p-4 sticky left-0 sm:static group-hover:text-primary transition-colors">{{ row }}</td>
                                {% for col in q.columns %}
                                    <td class="text-center p-4">
                                        <label class="cursor-pointer inline-flex items-center justify-center p-2 rounded-full hover:bg-primary/10 transition-colors">
                                            <input type="radio" name="{{ row }}_row{{ forloop.parentloop.counter }}" value="{{ col }}" class="radio radio-primary radio-sm" {% if q.required %}required{% endif %}>
                                        </label>
                                    </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

            <!-- 5. RATING -->
            {% elif q.NAME == 'Rating Question' %}
                    <div class="mt-4 px-1" x-data="{ rating: null, hover: null }">
                    <div class="flex justify-between items-end mb-4 px-1">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">{{ q.min_label|default:'Low' }}</span>
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">{{ q.max_label|default:'High' }}</span>
                    </div>
                    <div class="flex flex-wrap justify-center gap-2 sm:gap-4" @mouseleave="hover = null">
                        {% for i in q.range_min|get_range:q.range_max %}
                        <label class="cursor-pointer group relative flex-1 min-w-[40px] max-w-[60px]" @mouseenter="hover = {{ i }}">
                            <input type="radio" name="question_{{ q.position }}" value="{{ i }}" x-model="rating" class="sr-only" {% if q.required %}required{% endif %}>
                            <div class="aspect-square w-full rounded-xl border-2 flex items-center justify-center text-lg font-bold shadow-sm transition-all duration-200"
                                    :class="{'bg-primary border-primary text-white shadow-lg shadow-primary/30 -translate-y-2 scale-110': {{ i }} <= (hover || rating), 'bg-white border-slate-200 text-slate-400 group-hover:border-primary/30': {{ i }} > (hover || rating)}">
                                {{ i }}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

            <!-- 6. RANKING -->
            {% elif q.NAME == 'Ranking Question' %}
            <div class="mt-4" 
                    x-data="{ 
                    options: [
                        {% for option in q.options %}
                            '{{ option|escapejs }}'{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ],
                    swap(fromIndex, toIndex) {
                        if (toIndex >= 0 && toIndex < this.options.length) {
                            const temp = this.options[fromIndex];
                            this.options[fromIndex] = this.options[toIndex];
                            this.options[toIndex] = temp;
                        }
                    }
                    }">
                    <template x-for="option in options" :key="option">
                        <input type="hidden" name="question_{{ q.position }}" :value="option">
                    </template>
                    <!-- Re-implementing clearer ranking UI -->
                <div class="flex flex-col gap-3" x-auto-animate>
                    <template x-for="(option, index) in options" :key="option">
                        <div class="group flex items-center gap-3 p-3 bg-white border border-slate-200 rounded-xl shadow-sm hover:border-primary hover:shadow-md transition-all">
                                <div class="w-8 h-8 rounded-lg bg-slate-100 text-slate-500 font-bold flex items-center justify-center text-sm group-hover:bg-primary group-hover:text-white transition-colors" x-text="index + 1"></div>
                                <div class="flex-grow font-medium text-slate-700" x-text="option"></div>
                                <div class="flex flex-col gap-1">
                                    <button type="button" @click="swap(index, index - 1)" :disabled="index === 0" class="btn btn-xs btn-ghost btn-square disabled:opacity-20 hover:bg-primary/10 hover:text-primary"><i class="fa-solid fa-caret-up"></i></button>
                                    <button type="button" @click="swap(index, index + 1)" :disabled="index === options.length - 1" class="btn btn-xs btn-ghost btn-square disabled:opacity-20 hover:bg-primary/10 hover:text-primary"><i class="fa-solid fa-caret-down"></i></button>
                                </div>
                        </div> 
                    </template>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    <!-- Navigation Buttons -->
    <div class="flex flex-col gap-4 pt-8 pb-12">
        <!-- Global Error Message -->
        <div x-show="!isValid" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 -translate-y-2"
             x-transition:enter-end="opacity-100 translate-y-0"
             class="bg-red-50 border border-red-200 rounded-lg p-3 flex items-start gap-3 w-full animate-pulse">
            <i class="fa-solid fa-circle-exclamation text-red-500 mt-0.5"></i>
            <div>
                <h4 class="text-sm font-semibold text-red-700">Incomplete Section</h4>
                <p class="text-xs text-red-600 mt-1">Please answer all required questions marked with a red dot <span class="w-1.5 h-1.5 rounded-full bg-red-500 inline-block align-middle mx-0.5"></span> to proceed.</p>
            </div>
        </div>

        <div class="flex justify-between items-center w-full">
            <button type="button" class="btn btn-ghost hover:bg-slate-200 gap-2 text-slate-500" 
                    x-show="page > 0" 
                    @click="window.scrollTo({top: 0, behavior: 'smooth'}); page--">
                <i class="fa-solid fa-arrow-left"></i> Previous
            </button>
            
            <button type="button" class="btn btn-primary btn-lg px-8 rounded-xl shadow-lg shadow-primary/25 hover:shadow-primary/40 gap-3 disabled:bg-slate-200 disabled:text-slate-400 disabled:shadow-none disabled:border-slate-200" 
                    x-show="page < total - 1" 
                    :disabled="!isValid"
                    @click="window.scrollTo({top: 0, behavior: 'smooth'}); page++">
                Next Section <i class="fa-solid fa-arrow-right"></i>
            </button>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary btn-lg px-10 rounded-xl shadow-xl shadow-primary/30 hover:shadow-primary/50 hover:-translate-y-1 transition-all gap-3 bg-gradient-to-r from-primary to-primary-focus border-0 disabled:from-slate-300 disabled:to-slate-300 disabled:shadow-none disabled:text-slate-500" 
                x-show="page === total - 1"
                :disabled="!isValid">
                Submit Survey <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
    </div>

</div>
{% endfor %}